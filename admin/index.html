<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DelRey Admin</title>
  <link rel="icon" type="image/jpeg" href="/Logo%20Delrey.jfif">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            brand: {
              dark: '#141a17',
              gray: '#1c2520',
              green: '#0a714e',
              greenlight: '#0d8a5e',
              light: '#e8f2ed',
            }
          },
          fontFamily: {
            sans: ['"Poppins"', 'system-ui', 'sans-serif'],
          }
        }
      }
    }
  </script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap" rel="stylesheet">
</head>
<body class="bg-brand-dark text-brand-light font-sans antialiased min-h-screen">

  <!-- ========== VISTA LOGIN ========== -->
  <div id="login-view" class="min-h-screen flex items-center justify-center px-6">
    <div class="w-full max-w-sm">
      <h1 class="text-2xl font-extrabold text-center mb-2 tracking-tight">
        <span class="text-brand-green">DelRey</span> Admin
      </h1>
      <p class="text-brand-light/50 text-center text-sm mb-8">Ingresá tus credenciales para continuar</p>

      <form id="login-form" class="space-y-4">
        <div>
          <label for="email" class="block text-sm font-semibold mb-1.5 text-brand-light/70">Email</label>
          <input
            type="email" id="email" name="email" required autocomplete="email"
            class="w-full px-4 py-3 rounded-xl bg-brand-gray border border-white/10 text-white placeholder-brand-light/30 focus:outline-none focus:border-brand-green/50 focus:ring-1 focus:ring-brand-green/30 transition"
            placeholder="tu@email.com"
          >
        </div>
        <div>
          <label for="password" class="block text-sm font-semibold mb-1.5 text-brand-light/70">Contraseña</label>
          <input
            type="password" id="password" name="password" required autocomplete="current-password"
            class="w-full px-4 py-3 rounded-xl bg-brand-gray border border-white/10 text-white placeholder-brand-light/30 focus:outline-none focus:border-brand-green/50 focus:ring-1 focus:ring-brand-green/30 transition"
            placeholder="••••••••"
          >
        </div>
        <p id="login-error" class="text-red-400 text-sm hidden"></p>
        <button
          type="submit" id="login-btn"
          class="w-full bg-brand-green text-white font-bold py-3 rounded-xl text-lg hover:bg-brand-greenlight hover:shadow-lg hover:shadow-brand-green/20 hover:scale-[1.02] active:scale-[0.98] transition-all duration-200"
        >
          Ingresar
        </button>
      </form>

      <a href="/" class="block text-center mt-6 text-sm text-brand-light/40 hover:text-brand-green transition">
        &larr; Volver al sitio
      </a>
    </div>
  </div>

  <!-- ========== VISTA DASHBOARD ========== -->
  <div id="dashboard-view" class="hidden">
    <!-- Barra superior -->
    <div class="sticky top-0 z-30 bg-brand-dark/90 backdrop-blur-lg border-b border-white/5 px-6 py-3">
      <div class="max-w-5xl mx-auto flex items-center justify-between">
        <h1 class="text-lg font-extrabold tracking-tight">
          <span class="text-brand-green">DelRey</span> Admin
        </h1>
        <div class="flex items-center gap-3">
          <a href="/" class="text-sm text-brand-light/50 hover:text-white transition">Ver sitio</a>
          <button id="logout-btn" class="text-sm bg-brand-gray px-4 py-1.5 rounded-lg hover:bg-red-500/20 hover:text-red-400 transition">
            Cerrar sesión
          </button>
        </div>
      </div>
    </div>

    <div class="max-w-5xl mx-auto px-6 py-8">
      <!-- Subir foto -->
      <div class="mb-10">
        <h2 class="text-xl font-bold mb-4">Subir novedad</h2>
        <div class="flex flex-col sm:flex-row gap-4 items-start">
          <label class="cursor-pointer flex-1 w-full">
            <div id="upload-area" class="border-2 border-dashed border-white/10 rounded-2xl p-8 text-center hover:border-brand-green/40 transition-colors duration-200">
              <svg class="w-10 h-10 mx-auto mb-3 text-brand-light/30" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 16.5V9.75m0 0 3 3m-3-3-3 3M6.75 19.5a4.5 4.5 0 0 1-1.41-8.775 5.25 5.25 0 0 1 10.233-2.33 3 3 0 0 1 3.758 3.848A3.752 3.752 0 0 1 18 19.5H6.75Z"/>
              </svg>
              <p class="text-brand-light/50 text-sm" id="upload-text">Hacé clic o arrastrá una imagen aquí</p>
              <p class="text-brand-light/30 text-xs mt-1">JPEG, PNG o WebP — máx. 5MB</p>
            </div>
            <input type="file" id="file-input" accept="image/jpeg,image/png,image/webp" class="hidden">
          </label>
          <button
            id="upload-btn" disabled
            class="bg-brand-green text-white font-bold px-6 py-3 rounded-xl hover:bg-brand-greenlight hover:shadow-lg hover:shadow-brand-green/20 hover:scale-[1.02] active:scale-[0.98] transition-all duration-200 disabled:opacity-30 disabled:cursor-not-allowed disabled:hover:scale-100 disabled:hover:shadow-none"
          >
            Subir foto
          </button>
        </div>
        <!-- Descripción -->
        <div class="mt-4">
          <label for="description" class="block text-sm font-semibold mb-1.5 text-brand-light/70">Descripción (opcional)</label>
          <input
            type="text" id="description" maxlength="200" placeholder="Ej: Nueva colección de acuarelas disponible"
            class="w-full sm:max-w-md px-4 py-2.5 rounded-xl bg-brand-gray border border-white/10 text-white placeholder-brand-light/30 focus:outline-none focus:border-brand-green/50 focus:ring-1 focus:ring-brand-green/30 transition text-sm"
          >
        </div>
        <!-- Preview -->
        <div id="preview-container" class="mt-4 hidden">
          <img id="preview-img" class="w-40 h-30 object-cover rounded-xl border border-white/10" alt="Vista previa">
        </div>
        <p id="upload-status" class="mt-3 text-sm hidden"></p>
      </div>

      <!-- Grilla de fotos -->
      <div>
        <h2 class="text-xl font-bold mb-4">Novedades publicadas</h2>
        <div id="photos-loading" class="flex justify-center py-12">
          <div class="w-8 h-8 border-2 border-brand-green/30 border-t-brand-green rounded-full animate-spin"></div>
        </div>
        <div id="photos-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4"></div>
        <p id="photos-empty" class="text-center text-brand-light/40 py-12 hidden">No hay novedades subidas todavía.</p>
      </div>
    </div>
  </div>

  <!-- ========== MODAL CONFIRMAR ELIMINACIÓN ========== -->
  <div id="delete-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/60 backdrop-blur-sm px-6">
    <div class="bg-brand-gray rounded-2xl p-6 max-w-sm w-full shadow-2xl">
      <h3 class="text-lg font-bold mb-2">Eliminar foto</h3>
      <p class="text-brand-light/60 text-sm mb-6">¿Estás seguro? Esta acción no se puede deshacer.</p>
      <div class="flex gap-3 justify-end">
        <button id="delete-cancel" class="px-4 py-2 rounded-lg text-sm font-semibold hover:bg-white/5 transition">Cancelar</button>
        <button id="delete-confirm" class="px-4 py-2 rounded-lg text-sm font-semibold bg-red-500 text-white hover:bg-red-600 transition">Eliminar</button>
      </div>
    </div>
  </div>

  <script>
    const API = '/api';
    let token    = localStorage.getItem('admin_token');
    let selectedFile = null;
    let deleteId     = null;

    // Elementos
    const loginView       = document.getElementById('login-view');
    const dashboardView   = document.getElementById('dashboard-view');
    const loginForm       = document.getElementById('login-form');
    const loginError      = document.getElementById('login-error');
    const loginBtn        = document.getElementById('login-btn');
    const logoutBtn       = document.getElementById('logout-btn');
    const fileInput       = document.getElementById('file-input');
    const uploadBtn       = document.getElementById('upload-btn');
    const uploadText      = document.getElementById('upload-text');
    const uploadStatus    = document.getElementById('upload-status');
    const previewContainer = document.getElementById('preview-container');
    const previewImg      = document.getElementById('preview-img');
    const photosGrid      = document.getElementById('photos-grid');
    const photosLoading   = document.getElementById('photos-loading');
    const photosEmpty     = document.getElementById('photos-empty');
    const deleteModal     = document.getElementById('delete-modal');
    const deleteCancel    = document.getElementById('delete-cancel');
    const deleteConfirm   = document.getElementById('delete-confirm');

    // Verificar sesión al cargar
    if (token) showDashboard();

    // ── LOGIN ──────────────────────────────────────────────────────────────────
    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      loginError.classList.add('hidden');
      loginBtn.textContent = 'Ingresando...';
      loginBtn.disabled = true;

      try {
        const res = await fetch('/api/auth/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            email:    document.getElementById('email').value,
            password: document.getElementById('password').value,
          }),
        });

        const data = await res.json();
        if (!res.ok) {
          loginError.textContent = data.error || 'Error al ingresar';
          loginError.classList.remove('hidden');
          return;
        }

        token = data.token;
        localStorage.setItem('admin_token', token);
        showDashboard();
      } catch {
        loginError.textContent = 'Error de conexión';
        loginError.classList.remove('hidden');
      } finally {
        loginBtn.textContent = 'Ingresar';
        loginBtn.disabled = false;
      }
    });

    // ── LOGOUT ─────────────────────────────────────────────────────────────────
    logoutBtn.addEventListener('click', () => {
      token = null;
      localStorage.removeItem('admin_token');
      loginView.classList.remove('hidden');
      dashboardView.classList.add('hidden');
    });

    // ── SELECCIÓN DE ARCHIVO ───────────────────────────────────────────────────
    fileInput.addEventListener('change', () => {
      const file = fileInput.files[0];
      if (!file) return;

      if (file.size > 5 * 1024 * 1024) {
        showStatus('La imagen es demasiado grande. Máximo 5MB.', 'error');
        fileInput.value = '';
        return;
      }

      selectedFile = file;
      uploadBtn.disabled = false;
      uploadText.textContent = file.name;
      previewContainer.classList.remove('hidden');
      previewImg.src = URL.createObjectURL(file);
    });

    // ── SUBIR FOTO ─────────────────────────────────────────────────────────────
    uploadBtn.addEventListener('click', async () => {
      if (!selectedFile) return;

      uploadBtn.disabled = true;
      uploadBtn.textContent = 'Subiendo...';
      showStatus('Subiendo imagen...', 'info');

      try {
        const base64 = await fileToBase64(selectedFile);
        const res = await fetch(`${API}/photos/upload`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`,
          },
          body: JSON.stringify({
            image:       base64,
            contentType: selectedFile.type,
            description: document.getElementById('description').value.trim(),
          }),
        });

        if (res.status === 401) { handleUnauth(); return; }

        const data = await res.json();
        if (!res.ok) { showStatus(data.error || 'Error al subir', 'error'); return; }

        showStatus('Foto subida correctamente', 'success');
        selectedFile = null;
        fileInput.value = '';
        document.getElementById('description').value = '';
        uploadText.textContent = 'Hacé clic o arrastrá una imagen aquí';
        previewContainer.classList.add('hidden');
        loadPhotos();
      } catch {
        showStatus('Error de conexión', 'error');
      } finally {
        uploadBtn.disabled = true;
        uploadBtn.textContent = 'Subir foto';
      }
    });

    // ── ELIMINAR ───────────────────────────────────────────────────────────────
    deleteCancel.addEventListener('click', () => {
      deleteModal.classList.add('hidden');
      deleteModal.classList.remove('flex');
      deleteId = null;
    });

    deleteConfirm.addEventListener('click', async () => {
      if (!deleteId) return;

      deleteConfirm.textContent = 'Eliminando...';
      deleteConfirm.disabled = true;

      try {
        const res = await fetch(`${API}/photos/${deleteId}`, {
          method: 'DELETE',
          headers: { 'Authorization': `Bearer ${token}` },
        });

        if (res.status === 401) { handleUnauth(); return; }

        if (!res.ok) {
          const data = await res.json();
          showStatus(data.error || 'Error al eliminar', 'error');
          return;
        }

        loadPhotos();
      } catch {
        showStatus('Error de conexión', 'error');
      } finally {
        deleteModal.classList.add('hidden');
        deleteModal.classList.remove('flex');
        deleteConfirm.textContent = 'Eliminar';
        deleteConfirm.disabled = false;
        deleteId = null;
      }
    });

    // ── HELPERS ────────────────────────────────────────────────────────────────
    function showDashboard() {
      loginView.classList.add('hidden');
      dashboardView.classList.remove('hidden');
      loadPhotos();
    }

    async function loadPhotos() {
      photosLoading.classList.remove('hidden');
      photosGrid.innerHTML = '';
      photosEmpty.classList.add('hidden');

      try {
        const res = await fetch(`${API}/photos`);
        const { photos } = await res.json();
        photosLoading.classList.add('hidden');

        if (!photos || photos.length === 0) {
          photosEmpty.classList.remove('hidden');
          return;
        }

        photosGrid.innerHTML = photos.map(p => `
          <div class="group relative rounded-xl overflow-hidden bg-brand-gray border border-white/5">
            <div class="aspect-[4/3]">
              <img src="${p.url}" alt="Novedad" loading="lazy" class="w-full h-full object-cover">
            </div>
            ${p.description ? `<p class="px-2 py-1.5 text-xs text-brand-light/60 truncate">${escapeText(p.description)}</p>` : ''}
            <button
              onclick="confirmDelete('${p.id}')"
              class="absolute top-2 right-2 w-8 h-8 bg-red-500/80 hover:bg-red-500 text-white rounded-lg flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity duration-200"
              title="Eliminar"
            >
              <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0"/>
              </svg>
            </button>
          </div>
        `).join('');
      } catch {
        photosLoading.classList.add('hidden');
        photosEmpty.textContent = 'Error al cargar las fotos.';
        photosEmpty.classList.remove('hidden');
      }
    }

    function confirmDelete(id) {
      deleteId = id;
      deleteModal.classList.remove('hidden');
      deleteModal.classList.add('flex');
    }

    function handleUnauth() {
      token = null;
      localStorage.removeItem('admin_token');
      loginView.classList.remove('hidden');
      dashboardView.classList.add('hidden');
      loginError.textContent = 'Sesión expirada. Ingresá de nuevo.';
      loginError.classList.remove('hidden');
    }

    function showStatus(msg, type) {
      uploadStatus.textContent = msg;
      uploadStatus.classList.remove('hidden', 'text-green-400', 'text-red-400', 'text-brand-green');
      if (type === 'success') uploadStatus.classList.add('text-green-400');
      else if (type === 'error') uploadStatus.classList.add('text-red-400');
      else uploadStatus.classList.add('text-brand-green');
    }

    function escapeText(str) {
      const d = document.createElement('div');
      d.textContent = str;
      return d.innerHTML;
    }

    function fileToBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload  = () => resolve(reader.result.split(',')[1]);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }
  </script>
</body>
</html>
